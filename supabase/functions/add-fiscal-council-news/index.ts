import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import { corsHeaders } from '../_shared/cors.ts'

interface NewsItem {
  title: string;
  content: string;
  excerpt: string;
  date: string;
  category: string;
}

Deno.serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
    )

    // Предефинирани новини от фискалния съвет
    const newsItems: NewsItem[] = [
      {
        title: "Любомир Дацов: Излишните закони за еврото пораждат хаос и недоверие",
        content: "Любомир Дацов, член на Фискалния съвет, участва в предаване на ПИК ТВ за промените в Закона за приемане на еврото и другите два законопроекта на тази тема.\n\nТой заяви, че появата на такова законодателство, не говори за сила и яснота какво трябва да се направи, а за слабост. Според него няма никаква нужда от специални закони, защото тези промени са чисто технически – свързани с подравняване на табелките и уеднаквяване на шрифта.",
        excerpt: "Любомир Дацов коментира излишните закони за еврото в предаване на ПИК ТВ.",
        date: "2025-07-25",
        category: "новини"
      },
      {
        title: "Любомир Дацов: Инвестициите остават слаби, държавната администрация – раздута, а бюджетната политика без посока",
        content: "Любомир Дацов, член на Фискалния съвет, участва в предаването \"Твоят ден\" на NOVA NEWS по актуални за България финансови теми.\n\nГ-н Дацов изрази скептицизъм относно обявените от премиера икономически постижения и подчерта, че реален напредък ще има, когато чуждите инвестиции достигнат поне 7-8% от БВП.\n\n\"В последните години те са под 2%, основно в недвижими имоти – това не е сериозен успех\", заяви той.",
        excerpt: "Любомир Дацов коментира икономическите постижения и инвестициите в България.",
        date: "2025-07-21",
        category: "новини"
      },
      {
        title: "Десислава Калчева: Дискусията относно МФР не трябва да бъде само как да се похарчат повече средства умно и целесъобразно",
        content: "Д-р Десислава Калчева, член на Фискалния съвет участва в предаването \"България, Европа и светът на фокус\" на Радио \"Фокус\".\n\nВ първата част на участието се дискутира предложението за следваща Многогодишна финансова рамка. Д-р Калчева заяви, че предложеният бюджет от ЕК за 2 трилиона евро или 1,26% от брутния национален доход на ЕС, поражда сериозно противопоставяне между държавите членки от Западна Европа и тези от Централна и Източна.",
        excerpt: "Д-р Десислава Калчева коментира Многогодишната финансова рамка на ЕС.",
        date: "2025-07-21",
        category: "новини"
      },
      {
        title: "Участие на д-р Десислава Калчева в обучението на стажант-аташетата на Дипломатическия институт",
        content: "На 14 юли 2025 г. д-р Десислава Калчева, член на Фискалния съвет на България, участва като лектор в програмата за обучение на стажант-аташета на Дипломатическия институт към Министерството на външните работи.\n\nЛекцията ѝ, озаглавена \"Многогодишната финансова рамка на ЕС – от невъзможното до реалното\", представи в дълбочина процесите по изготвяне и договаряне на рамката, с акцент върху нейната стратегическа роля в европейската.",
        excerpt: "Д-р Десислава Калчева лектор в обучението на дипломати за европейската финансова рамка.",
        date: "2025-07-15",
        category: "обучение"
      },
      {
        title: "Симеон Дянков: Доналд Тръмп и Теменужка Петкова ни вкараха в еврозоната",
        content: "Председателят на Фискалния съвет д-р Симеон Дянков участва в предаването \"120 минути\" на БТВ на тема членството на България в Еврозоната. Той заяви, че геополитическата ситуация е помогнала на България да се присъедини към еврозоната, а президентът на САЩ Доналд Тръмп и финансовият министър Теменужка Петкова са основните фигури за нашия успех.\n\nД-р Дянков призова да се предприемат законодателни промени по отношение на еврото.",
        excerpt: "Председателят на Фискалния съвет коментира членството на България в еврозоната.",
        date: "2025-07-14",
        category: "новини"
      }
    ];

    console.log(`Добавяне на ${newsItems.length} новини в базата данни...`);

    // Добавяне на новините в базата данни
    for (const newsItem of newsItems) {
      const { data, error } = await supabaseClient
        .from('news')
        .insert({
          title_bg: newsItem.title,
          content_bg: newsItem.content,
          excerpt_bg: newsItem.excerpt,
          category: newsItem.category,
          published: true,
          featured: false,
          created_at: newsItem.date,
          updated_at: newsItem.date
        });

      if (error) {
        console.error(`Грешка при добавяне на новината "${newsItem.title}":`, error);
      } else {
        console.log(`Успешно добавена новината: "${newsItem.title}"`);
      }
    }

    return new Response(
      JSON.stringify({ 
        success: true, 
        message: `Успешно добавени ${newsItems.length} новини от Фискалния съвет`,
        added: newsItems.length
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200 
      }
    );

  } catch (error) {
    console.error('Грешка при добавяне на новините:', error);
    return new Response(
      JSON.stringify({ 
        success: false, 
        error: error.message 
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 500 
      }
    );
  }
});